# 字符串

## 字典树

 字典树，又称Trie、单词查找树，是一种树形结构，也是哈希树的一种变种，主要用于统计、排序和存储大量的字符串（但不限于字符串），经常被搜索引擎系统用于文本词频统计。

 字典树利用字符串的公共前缀来减少查询时间，最大限度地减少无谓的字符串比较，查询效率比哈希树高。

例如，`bee`是一个单词，`beer`也是一个单词，可以在每个单词结束的位置都加一个`end[]`标记，表示从根到这里有一个单词。

![image-20220913151613420](https://victor-gx.oss-cn-beijing.aliyuncs.com/img/2022/DSA/202209131516473.png)

### 字典树的插入

插入操作指将一个字符串插入字典树中。字典树可以采用数组或链表存储，这里采用数组存储实现静态链表。

![image-20220913151651642](https://victor-gx.oss-cn-beijing.aliyuncs.com/img/2022/DSA/202209131516676.png)

1. 插入一个单词`s=“bike”`，首先将字符转换为数字，`s[0]–‘a’=1`，判断`trie[1][1]`为`0`，令`trie[1][1]=2`，相当于创建一个新的节点（节点的存储下标为`2`）

![image-20220913151730248](https://victor-gx.oss-cn-beijing.aliyuncs.com/img/2022/DSA/202209131517284.png)

![image-20220913151739701](https://victor-gx.oss-cn-beijing.aliyuncs.com/img/2022/DSA/202209131517743.png)

![image-20220913151747359](https://victor-gx.oss-cn-beijing.aliyuncs.com/img/2022/DSA/202209131517422.png)

### 字典树的查找

在字典树中查找一个字符串是否存在，则和插入操作一样，首先将字符转换为数字，在字典树中查找，若查找的位置为0，则说明不存在，否则继续向下查找；在字符串处理完毕后，判断此处是否有单词结束标记，若有，则查找成功。

![image-20220913151815681](https://victor-gx.oss-cn-beijing.aliyuncs.com/img/2022/DSA/202209131518756.png)

### 字典树的应用

1. 字符串检索。事先将字符串（字典）存储到Trie，查找字符串、出现的频率和搜索引擎的热门查询。
2. 前缀统计。统计一个字符串所有前缀单词的个数，只需统计从根到叶子路径上单词出现的个数，也可以判断一个单词是否为另一个单词的前缀。
3. 最长公共前缀。两个字符串的最长公共前缀的长度就是它们所在节点最近公共祖先到根的长度。
4. 排序。利用字典树进行串排序，对字典树先序遍历，输出的相应字符串便是按字典序排序的结果。
5. 作为其他数据结构与算法的辅助结构，例如后缀树、AC自动机等。

## AC自动机

AC自动机是KMP算法和Trie树的结合，是经典的多模匹配算法。首先将多个模式串构建一棵字典树，然后在字典树上添加失配指针，失配指针相当于KMP算法中的next函数（匹配失败时的回退位置），最后将主串在Trie树上进行模式匹配。

 AC自动机算法分为3步：

1. 构建一棵字典树；
2. 构建AC自动机；
3. 进行模式匹配。

### 构建字典树

插入一个字符串时，从前往后遍历字符串，从字典树的根开始判断当前要插入的字符节点是否已存在，若已存在，则沿该分支遍历下一个字符；若不存在，则创建一个新节点表示这个字符。继续遍历其他字符，直到字符串处理完毕。

假设有单词`she`、`he`、`his`、`hers`，构建一棵字典树。

![image-20220913152129995](https://victor-gx.oss-cn-beijing.aliyuncs.com/img/2022/DSA/202209131521036.png)

### 构建AC自动机

 KMP算法中的`next`函数（回退函数或者`fail`函数）。`next`函数表示`S[i]`与`T[j]`不等时`j`应该回退的位置。

![image-20220913152241357](https://victor-gx.oss-cn-beijing.aliyuncs.com/img/2022/DSA/202209131522398.png)

AC 自动机的失配指针有同样的功能，匹配失败时，跳转到当前节点的失配指针所指向的节点，再次进行匹配操作。AC 自动机可以实现多模式匹配，归功于失配指针（`fail` 指针）。

 给字典树的每个节点添加失配指针，AC 自动机就构造完成了。

 AC 自动机的失配指针指向的节点代表的字符串是当前节点代表的字符串的最长后缀。

![image-20220913152321983](https://victor-gx.oss-cn-beijing.aliyuncs.com/img/2022/DSA/202209131523032.png)

对于当前节点`t`，`t`的子指针`t->ch[i]`分为两种情况：

- `t->ch[i]`不为空：`t->ch[i]`的失配指针指向`t->fail->ch[i]`。
- `t->ch[i]`为空：`t->ch[i]`指向`t->fail->ch[i]`。

![image-20220913152343385](https://victor-gx.oss-cn-beijing.aliyuncs.com/img/2022/DSA/202209131523436.png)

**算法步骤**：

1. 树根入队。
2. 若队列不为空，则取队头元素`t`并出队，访问`t`的每一个子节点`t->ch[i]`：
   - `t->ch[i]`不为空：`t->ch[i]`的失配指针指向`t->fail->ch[i]`， 并将`t->ch[i]` 入队。
   - `t->ch[i]`为空：`t->ch[i]`指向`t->fail->ch[i]`。

3. 队空时，算法结束。

### 模式匹配

 模式匹配指从树根开始处理模式串的每个字符，沿着当前字符的 `fail` 指针，一直遍历到`u->count=-1`为止，在遍历过程中累加这些节点的`u->count`，累加后将节点标记为`u->count=–1`，避免重复统计。`u->count`大于或等于`1`的节点都是可以匹配的节点。

**性能分析**

给定`k`个单词和一段包含`n`个字符的文章，求有多少个单词在文章里出现过。

 若使用KMP算法，则每个模式串$T_i$都要与主串`S`进行一次匹配，总时间复杂度为$O(n×k+m)$，其中`n`为主串`S`的长度，`m`为模式串$T_1,T_2,T_3,…,T_k$的长度之和，`k`为模式串的个数。而采用AC自动机，时间复杂度只需$O(n+m)$。